#!/usr/bin/expect -f

set timeout 300

# VPS bilgileri
set vps_ip "31.97.78.86"
set vps_user "root"
set vps_password "00203549Rk.."
set package_file "syncarch-vps-latest.tar.gz"

puts "\nğŸš€ SyncArch VPS Deployment BaÅŸlÄ±yor...\n"

# 1. DosyayÄ± yÃ¼kle
puts "ğŸ“¤ 1/3 - Paket yÃ¼kleniyor..."
spawn scp -o StrictHostKeyChecking=no $package_file ${vps_user}@${vps_ip}:/tmp/
expect {
    "password:" {
        send "${vps_password}\r"
        expect eof
    }
    timeout {
        puts "\nâŒ Dosya yÃ¼kleme timeout!"
        exit 1
    }
}

puts "âœ“ Paket yÃ¼klendi\n"

# 2. Deployment komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±r
puts "ğŸ”§ 2/3 - Deployment Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
spawn ssh -o StrictHostKeyChecking=no ${vps_user}@${vps_ip}
expect {
    "password:" {
        send "${vps_password}\r"
        expect "# "
    }
    timeout {
        puts "\nâŒ SSH baÄŸlantÄ± timeout!"
        exit 1
    }
}

# Deployment komutlarÄ±
send "cd /var/www/syncarch\r"
expect "# "

send "BACKUP_DIR=\"backup-\$(date +%Y%m%d-%H%M%S)\"\r"
expect "# "

send "mkdir -p \$BACKUP_DIR\r"
expect "# "

send "\[ -d \"dist\" \] && cp -r dist \$BACKUP_DIR/ && echo \"âœ“ Yedek alÄ±ndÄ±: \$BACKUP_DIR\"\r"
expect "# "

send "tar -xzf /tmp/$package_file -C /var/www/syncarch\r"
expect "# "

send "rm -f /tmp/$package_file\r"
expect "# "

send "echo \"âœ“ Dosyalar Ã§Ä±karÄ±ldÄ±\"\r"
expect "# "

send "npm install --production\r"
expect {
    "# " {
        send "echo \"âœ“ BaÄŸÄ±mlÄ±lÄ±klar kuruldu\"\r"
        expect "# "
    }
    timeout {
        puts "\nâš ï¸  npm install timeout, devam ediliyor..."
    }
}

send "pm2 restart syncarch || pm2 start server/index.js --name syncarch\r"
expect "# "

send "pm2 save\r"
expect "# "

send "echo \"âœ“ PM2 servisi gÃ¼ncellendi\"\r"
expect "# "

send "nginx -t && systemctl reload nginx\r"
expect "# "

send "echo \"âœ“ Nginx yenilendi\"\r"
expect "# "

send "echo \"\nğŸ“Š Servis Durumu:\"\r"
expect "# "

send "pm2 list\r"
expect "# "

send "echo \"\nğŸŒ Deployment TamamlandÄ±!\"\r"
expect "# "

send "echo \"   â€¢ https://syncarch.xyz\"\r"
expect "# "

send "exit\r"
expect eof

puts "\nâœ… DEPLOYMENT BAÅARILI!\n"
